<!DOCTYPE html>
<html lang="he" dir="rtl">
<!-- גרסה מתוקנת למובייל -->
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ניהול רכישה קבוצתית - כורסת עיסוי</title>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Heebo', sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      padding: 20px;
    }
    
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #eee;
    }
    
    .login-container {
      max-width: 400px;
      margin: 100px auto;
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      padding: 30px;
      text-align: center;
    }
    
    .login-form {
      margin-top: 20px;
    }
    
    .form-group {
      margin-bottom: 15px;
      text-align: right;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    input[type="password"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }
    
    button {
      background: linear-gradient(135deg, #4CAF50, #8BC34A);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      width: 100%;
      margin-top: 10px;
      transition: all 0.3s ease;
    }
    
    button:hover {
      background: linear-gradient(135deg, #43A047, #7CB342);
      transform: translateY(-2px);
      box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
    }
    
    .error-message {
      color: #f44336;
      margin-top: 10px;
    }
    
    .dashboard {
      display: none;
    }
    
    .stats {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    
    .stat-card {
      flex: 1;
      min-width: 200px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin: 10px;
      text-align: center;
    }
    
    .stat-card h3 {
      color: #555;
      font-size: 16px;
      margin-bottom: 10px;
    }
    
    .stat-card .value {
      font-size: 28px;
      font-weight: 700;
      color: #333;
    }
    
    .stat-card.primary {
      border-top: 4px solid #4CAF50;
    }
    
    .stat-card.secondary {
      border-top: 4px solid #2196F3;
    }
    
    .stat-card.warning {
      border-top: 4px solid #FFC107;
    }
    
    .stat-card.danger {
      border-top: 4px solid #F44336;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    
    th, td {
      padding: 15px;
      text-align: right;
      border-bottom: 1px solid #eee;
    }
    
    th {
      background-color: #f8f9fa;
      font-weight: 500;
      color: #555;
    }
    
    tr:hover {
      background-color: #f5f5f5;
    }
    
    .action-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    
    .btn-view, .btn-delete {
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .btn-view {
      background-color: #2196F3;
      color: white;
    }
    
    .btn-delete {
      background-color: #F44336;
      color: white;
    }
    
    .search-container {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
    }
    
    .search-container input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }
    
    .search-container button {
      width: auto;
    }
    
    .export-btn {
      background: linear-gradient(135deg, #2196F3, #03A9F4);
      margin-bottom: 20px;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background-color: #fff;
      padding: 30px;
      border-radius: 10px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .modal-close {
      cursor: pointer;
      font-size: 24px;
      color: #555;
    }
    
    .user-details {
      margin-bottom: 20px;
    }
    
    .user-details div {
      margin-bottom: 10px;
      display: flex;
    }
    
    .user-details strong {
      min-width: 150px;
      display: inline-block;
    }
    
    @media (max-width: 768px) {
      .stats {
        flex-direction: column;
      }
      
      table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }
      
      .search-container {
        flex-direction: column;
      }
      
      .login-container {
        width: 90%;
        margin: 50px auto;
        padding: 20px;
      }
      
      .modal-content {
        width: 95%;
        max-height: 90vh;
      }
      
      .user-details div {
        flex-direction: column;
      }
      
      .user-details strong {
        margin-bottom: 5px;
      }
      
      .container {
        padding: 10px;
      }
      
      h1 {
        font-size: 20px;
      }
      
      .btn-view, .btn-delete {
        padding: 8px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <!-- מסך התחברות -->
  <div id="login-screen" class="login-container">
    <h2>התחברות למערכת ניהול</h2>
    <p>הזן את הסיסמה כדי לצפות בנתוני הנרשמים</p>
    
    <div class="login-form">
      <div class="form-group">
        <label for="password">סיסמה:</label>
        <input type="password" id="password" placeholder="הזן סיסמה">
      </div>
      
      <button id="login-btn">התחבר</button>
      <p id="error-message" class="error-message"></p>
    </div>
  </div>
  
  <!-- לוח מחוונים -->
  <div id="dashboard" class="dashboard container">
    <h1>ניהול רכישה קבוצתית - כורסת עיסוי</h1>
    
    <!-- סטטיסטיקות -->
    <div class="stats">
      <div class="stat-card primary">
        <h3>סה"כ נרשמים</h3>
        <div id="total-registrations" class="value">0</div>
      </div>
      
      <div class="stat-card secondary">
        <h3>משלמים</h3>
        <div id="total-paid" class="value">0</div>
      </div>
      
      <div class="stat-card warning">
        <h3>ממוצע מחיר</h3>
        <div id="avg-price" class="value">₪0</div>
      </div>
      
      <div class="stat-card danger">
        <h3>סה"כ הכנסות</h3>
        <div id="total-revenue" class="value">₪0</div>
      </div>
    </div>
    
    <!-- חיפוש וייצוא -->
    <div class="search-container">
      <input type="text" id="search-input" placeholder="חיפוש לפי שם, טלפון או אימייל...">
      <button id="search-btn">חיפוש</button>
    </div>
    
    <button id="export-btn" class="export-btn">ייצוא לקובץ Excel</button>
    
    <!-- טבלת נרשמים -->
    <table id="registrations-table">
      <thead>
        <tr>
          <th>#</th>
          <th>שם מלא</th>
          <th>טלפון</th>
          <th>אימייל</th>
          <th>עיר</th>
          <th>תאריך רישום</th>
          <th>סטטוס תשלום</th>
          <th>פעולות</th>
        </tr>
      </thead>
      <tbody id="registrations-body">
        <!-- תוכן הטבלה יתמלא דינמית -->
      </tbody>
    </table>
  </div>
  
  <!-- מודל לצפייה בפרטי משתמש -->
  <div id="user-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>פרטי משתמש</h2>
        <span class="modal-close">&times;</span>
      </div>
      
      <div id="user-details" class="user-details">
        <!-- פרטי המשתמש יתמלאו דינמית -->
      </div>
    </div>
  </div>
  
  <script>
    // הגדרת סיסמה למערכת הניהול
    const ADMIN_PASSWORD = '123456';
    
    // אלמנטים בדף
    const loginScreen = document.getElementById('login-screen');
    const dashboard = document.getElementById('dashboard');
    const loginBtn = document.getElementById('login-btn');
    const passwordInput = document.getElementById('password');
    const errorMessage = document.getElementById('error-message');
    const searchInput = document.getElementById('search-input');
    const searchBtn = document.getElementById('search-btn');
    const exportBtn = document.getElementById('export-btn');
    const registrationsBody = document.getElementById('registrations-body');
    const userModal = document.getElementById('user-modal');
    const userDetails = document.getElementById('user-details');
    const modalClose = document.querySelector('.modal-close');
    
    // סטטיסטיקות
    const totalRegistrationsElement = document.getElementById('total-registrations');
    const totalPaidElement = document.getElementById('total-paid');
    const avgPriceElement = document.getElementById('avg-price');
    const totalRevenueElement = document.getElementById('total-revenue');
    
    // מערך לשמירת כל הנרשמים
    let registrations = [];
    
    // פונקציה לאתחול הדף
    function init() {
      console.log('אתחול דף הניהול');
      
      // התאמה למובייל
      if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
        document.body.classList.add('mobile-device');
        console.log('זוהה מכשיר נייד');
      }
      
      // בדיקה אם המשתמש כבר מחובר
      const isLoggedIn = sessionStorage.getItem('adminLoggedIn');
      console.log('סטטוס התחברות:', isLoggedIn);
      if (isLoggedIn === 'true') {
        showDashboard();
      }
      
      // הוספת מאזינים לאירועים
      loginBtn.addEventListener('click', handleLogin);
      passwordInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          handleLogin();
        }
      });
      
      searchBtn.addEventListener('click', filterRegistrations);
      searchInput.addEventListener('keyup', filterRegistrations);
      exportBtn.addEventListener('click', exportToExcel);
      modalClose.addEventListener('click', closeModal);
      
      // טעינת נתונים מ-localStorage
      loadRegistrationsData();
    }
    
    // פונקציה לטיפול בהתחברות
    function handleLogin() {
      const password = passwordInput.value;
      console.log('ניסיון התחברות עם סיסמה:', password);
      
      if (password === ADMIN_PASSWORD) {
        console.log('התחברות הצליחה');
        sessionStorage.setItem('adminLoggedIn', 'true');
        showDashboard();
      } else {
        console.log('התחברות נכשלה: סיסמה שגויה');
        errorMessage.textContent = 'סיסמה שגויה. נסה שוב.';
        passwordInput.value = '';
      }
    }
    
    // פונקציה להצגת לוח המחוונים
    function showDashboard() {
      console.log('מציג את לוח המחוונים');
      loginScreen.style.display = 'none';
      dashboard.style.display = 'block';
      
      // גלילה לראש הדף לאחר התחברות
      window.scrollTo(0, 0);
      
      loadRegistrationsData();
    }
    
    // פונקציה לטעינת נתוני הנרשמים מ-localStorage
    function loadRegistrationsData() {
      // איסוף כל הנתונים מ-localStorage
      registrations = [];
      
      // בדיקה אם יש נתוני משתמשים ב-localStorage
      const userDetailsStr = localStorage.getItem('userDetails');
      if (userDetailsStr) {
        try {
          const userDetails = JSON.parse(userDetailsStr);
          // הוספת תאריך רישום אם לא קיים
          if (!userDetails.registrationDate) {
            userDetails.registrationDate = new Date().toISOString();
          }
          // הוספת סטטוס תשלום אם לא קיים
          if (!userDetails.paymentStatus) {
            const paymentDetailsStr = localStorage.getItem('paymentDetails');
            userDetails.paymentStatus = paymentDetailsStr ? 'שולם' : 'ממתין לתשלום';
          }
          registrations.push(userDetails);
        } catch (e) {
          console.error('שגיאה בטעינת נתוני משתמש:', e);
        }
      }
      
      // חיפוש נתוני משתמשים נוספים ב-localStorage
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('userDetails_')) {
          try {
            const userDetailsStr = localStorage.getItem(key);
            const userDetails = JSON.parse(userDetailsStr);
            // הוספת תאריך רישום אם לא קיים
            if (!userDetails.registrationDate) {
              userDetails.registrationDate = new Date().toISOString();
            }
            // הוספת סטטוס תשלום אם לא קיים
            if (!userDetails.paymentStatus) {
              const paymentKey = 'paymentDetails_' + key.split('_')[1];
              const paymentDetailsStr = localStorage.getItem(paymentKey);
              userDetails.paymentStatus = paymentDetailsStr ? 'שולם' : 'ממתין לתשלום';
            }
            registrations.push(userDetails);
          } catch (e) {
            console.error('שגיאה בטעינת נתוני משתמש:', e, key);
          }
        }
      }
      
      // עדכון הסטטיסטיקות
      updateStatistics();
      
      // הצגת הנתונים בטבלה
      displayRegistrations(registrations);
    }
    
    // פונקציה לעדכון הסטטיסטיקות
    function updateStatistics() {
      const totalRegistrations = registrations.length;
      const totalPaid = registrations.filter(reg => reg.paymentStatus === 'שולם').length;
      
      // חישוב ממוצע מחיר והכנסות
      let totalRevenue = 0;
      registrations.forEach(reg => {
        if (reg.paymentStatus === 'שולם') {
          // אם יש מחיר ספציפי למשתמש זה
          const price = reg.finalPrice || 4000; // ברירת מחדל אם אין מחיר ספציפי
          totalRevenue += price;
        }
      });
      
      const avgPrice = totalPaid > 0 ? Math.round(totalRevenue / totalPaid) : 0;
      
      // עדכון התצוגה
      totalRegistrationsElement.textContent = totalRegistrations;
      totalPaidElement.textContent = totalPaid;
      avgPriceElement.textContent = `₪${avgPrice.toLocaleString()}`;
      totalRevenueElement.textContent = `₪${totalRevenue.toLocaleString()}`;
    }
    
    // פונקציה להצגת הנרשמים בטבלה
    function displayRegistrations(regs) {
      registrationsBody.innerHTML = '';
      
      if (regs.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="8" style="text-align: center;">לא נמצאו נרשמים</td>`;
        registrationsBody.appendChild(row);
        return;
      }
      
      regs.forEach((reg, index) => {
        const row = document.createElement('tr');
        
        // פורמט תאריך
        let formattedDate = 'לא ידוע';
        if (reg.registrationDate) {
          const date = new Date(reg.registrationDate);
          formattedDate = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
        }
        
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${reg.firstName || ''} ${reg.lastName || ''}</td>
          <td>${reg.phone || ''}</td>
          <td>${reg.email || ''}</td>
          <td>${reg.city || ''}</td>
          <td>${formattedDate}</td>
          <td>${reg.paymentStatus || 'ממתין לתשלום'}</td>
          <td class="action-buttons">
            <button class="btn-view" data-index="${index}">צפייה</button>
            <button class="btn-delete" data-index="${index}">מחיקה</button>
          </td>
        `;
        
        registrationsBody.appendChild(row);
      });
      
      // הוספת מאזינים לכפתורי פעולה
      document.querySelectorAll('.btn-view').forEach(btn => {
        btn.addEventListener('click', function() {
          const index = this.getAttribute('data-index');
          showUserDetails(registrations[index]);
        });
      });
      
      document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', function() {
          const index = this.getAttribute('data-index');
          deleteRegistration(index);
        });
      });
    }
    
    // פונקציה לסינון הנרשמים לפי חיפוש
    function filterRegistrations() {
      const searchTerm = searchInput.value.toLowerCase();
      
      if (!searchTerm) {
        displayRegistrations(registrations);
        return;
      }
      
      const filteredRegistrations = registrations.filter(reg => {
        return (
          (reg.firstName && reg.firstName.toLowerCase().includes(searchTerm)) ||
          (reg.lastName && reg.lastName.toLowerCase().includes(searchTerm)) ||
          (reg.phone && reg.phone.includes(searchTerm)) ||
          (reg.email && reg.email.toLowerCase().includes(searchTerm)) ||
          (reg.city && reg.city.toLowerCase().includes(searchTerm))
        );
      });
      
      displayRegistrations(filteredRegistrations);
    }
    
    // פונקציה להצגת פרטי משתמש במודל
    function showUserDetails(user) {
      userDetails.innerHTML = '';
      
      // יצירת שדות לכל המידע
      const fields = [
        { label: 'שם פרטי', value: user.firstName },
        { label: 'שם משפחה', value: user.lastName },
        { label: 'טלפון', value: user.phone },
        { label: 'אימייל', value: user.email },
        { label: 'עיר', value: user.city },
        { label: 'רחוב', value: user.street },
        { label: 'מספר בית', value: user.houseNumber },
        { label: 'דירה', value: user.apartment },
        { label: 'קומה', value: user.floor },
        { label: 'כניסה', value: user.entrance },
        { label: 'מיקוד', value: user.zipCode },
        { label: 'הערות', value: user.notes },
        { label: 'שיטת משלוח', value: user.deliveryMethod === 'regular' ? 'רגיל' : 'אקספרס' },
        { label: 'סטטוס תשלום', value: user.paymentStatus || 'ממתין לתשלום' },
        { label: 'תאריך רישום', value: user.registrationDate ? new Date(user.registrationDate).toLocaleString('he-IL') : 'לא ידוע' }
      ];
      
      // הוספת שדות נוספים אם קיימים
      if (user.paymentDetails) {
        fields.push({ label: 'פרטי תשלום', value: JSON.stringify(user.paymentDetails) });
      }
      
      // יצירת האלמנטים בדף
      fields.forEach(field => {
        if (field.value) {
          const div = document.createElement('div');
          div.innerHTML = `<strong>${field.label}:</strong> <span>${field.value}</span>`;
          userDetails.appendChild(div);
        }
      });
      
      // הצגת המודל
      userModal.style.display = 'flex';
    }
    
    // פונקציה לסגירת המודל
    function closeModal() {
      userModal.style.display = 'none';
    }
    
    // פונקציה למחיקת רישום
    function deleteRegistration(index) {
      if (confirm('האם אתה בטוח שברצונך למחוק רישום זה?')) {
        // מחיקה מ-localStorage
        const user = registrations[index];
        
        // מחיקה מהמערך
        registrations.splice(index, 1);
        
        // עדכון הסטטיסטיקות והתצוגה
        updateStatistics();
        displayRegistrations(registrations);
        
        alert('הרישום נמחק בהצלחה');
      }
    }
    
    // פונקציה לייצוא הנתונים לאקסל
    function exportToExcel() {
      // יצירת CSV
      let csv = 'מס.,שם פרטי,שם משפחה,טלפון,אימייל,עיר,רחוב,מספר בית,דירה,קומה,כניסה,מיקוד,הערות,שיטת משלוח,סטטוס תשלום,תאריך רישום\n';
      
      registrations.forEach((reg, index) => {
        const deliveryMethod = reg.deliveryMethod === 'regular' ? 'רגיל' : 'אקספרס';
        const date = reg.registrationDate ? new Date(reg.registrationDate).toLocaleString('he-IL') : '';
        
        csv += `${index + 1},${reg.firstName || ''},${reg.lastName || ''},${reg.phone || ''},${reg.email || ''},${reg.city || ''},${reg.street || ''},${reg.houseNumber || ''},${reg.apartment || ''},${reg.floor || ''},${reg.entrance || ''},${reg.zipCode || ''},${reg.notes || ''},${deliveryMethod},${reg.paymentStatus || 'ממתין לתשלום'},${date}\n`;
      });
      
      // יצירת קובץ להורדה
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', `נרשמים_לרכישה_קבוצתית_${new Date().toLocaleDateString()}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    // סגירת המודל כאשר לוחצים מחוץ לתוכן
    window.onclick = function(event) {
      if (event.target === userModal) {
        closeModal();
      }
    };
    
    // אתחול הדף
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
